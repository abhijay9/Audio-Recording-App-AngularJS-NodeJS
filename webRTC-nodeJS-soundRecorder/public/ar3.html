<html>
<head>
   <title>Angular JS Views</title>
   <meta name="viewport" content="width=device-width">
  <link rel="stylesheet" href="style/normalize.css">
  <link rel="stylesheet" href="style/font-awesome.css">
  <link rel="stylesheet" href="style/ospb.css">
  <link rel="stylesheet" href="style/horizontal.css">
  
  <script type="text/javascript" src="bower_components/jquery/dist/jquery.js"></script>
  <script type="text/javascript" src="bower_components/angular/angular.min.js"></script>
  <script src="js/Horizontal examples - Sly_files/ga.js"></script>
  <script src="js/Horizontal examples - Sly_files/modernizr.js"></script>
  
  <script src="js/RecordRTC.js"></script>
  <script src="js/ConcatenateBlobs.js"></script>
  
   <script src="js/angular-route.min.js"></script>
   <script src="js/arController.js"></script>
   
   
</head>
<body>
   <script type="text/javascript">
    var newSeq=[],sequence_arr=[],time_arr=[],sentence_arr=[], difftime=[],timesecond_arr=[];
    var finaltime, url2;
    var sentence_arrIterator,sequence_arrIterator,timesecond_arrIterator,realIterator;
    var blobArray=[];
    var CCOUNT = 60;
    var flag=0;
    var t, count;
   </script>

   <h2>Recorder</h2>
   <div ng-app="mainApp">
      <b><i><a href="#addSrt">Load SRT</a></i></b>
      <p><b><i><a href="#viewRecorder">View Recorder</a></b></i>
      <div ng-view></div>
      <script type="text/ng-template" id="addSrt.htm">
         <h2> Load SRT </h2>
         <input type="file" onchange="angular.element(this).scope().srtChange()" >
         {{message}}
         
      </script>
      
      <script type="text/ng-template" id="viewRecorder.htm">
         
         <h2> Sound Recorder </h2>	    
         {{message}}

         <div id="firstDiv" class="pagespan container" ng-init="init()">
            <div class="wrap">
               <h2>Centered <small>- activated or middle item is centered when possible</small></h2>

                  <div class="scrollbar">
                     <div class="handle" style="transform: translateZ(0px) translateX(76px); width: 190px;">
                        <div class="mousearea"></div>
                     </div>
                  </div>
                  
                  
               <div  class="frame" id="forcecentered" style="overflow: hidden;" >
                  <ul id="seqNum" class="clearfix" style="transform: translateZ(0px) translateX(-455px); width: 6840px;">
               
                     <li ng-repeat="seq in seqArr track by $index" ng-click="liClicked($index)"> 
                        <label id="label-{{$index}}">{{$index}}</label>
                     </li>
                  </ul>
               </div>
               <button class=
               
               <div class="controls center">
                  <button class="btn prev"><i class="icon-chevron-left"></i> prev</button>
                  <button class="btn next">next <i class="icon-chevron-right"></i></button>

               </div>
            </div>      
         </div>
         </div>   

      </script>
          

      <span id="previous">
      </span>
      <span id="current">
      </span>
      <span id="future">
      </span>


      <span id="timespan"></span>
      <div style="visibilty:hidden"> 
                    <input type="button" value="Start" onclick="countdown()">
                    <input type="button" value="Stop" onclick="cdpause()">
                    <input type="button" value="Reset" onclick="cdreset()">
      </div>
            <section>
              <button id="audio-together">Play together</button>
              <div class="inner" style="height: 5em;">
                <audio id="audio" autoplay controls></audio>
                <button id="record-audio">Record</button>
                <button id="pause-resume-audio" disabled>Pause</button>
                <button id="stop-recording-audio" disabled>Stop</button>
                <h2 id="audio-url-preview"></h2>
                <h2 id="audio-blob-preview"></h2>
              </div>
            
            <audio id="audio-control-together" autoplay controls></audio>
        </section>
      
      <script type="text/javascript">

    (function() {
        var params = {},
                    r = /([^&=]+)=?([^&]*)/g;

                function d(s) {
                    return decodeURIComponent(s.replace(/\+/g, ' '));
                }

                var match, search = window.location.search;
                while (match = r.exec(search.substring(1)))
                    params[d(match[1])] = d(match[2]);

                window.params = params;        
    })();


        function getByID(id) {
            return document.getElementById(id);
        }

        var recordAudio = getByID('record-audio'),
            stopRecordingAudio = getByID('stop-recording-audio'),
            pauseResumeAudio = getByID('pause-resume-audio'),
            playTogether=getByID('audio-together'),
            audioTogether=getByID('audio-control-together');

        var audio = getByID('audio');

       
        var audioConstraints = {
            audio: true,
            video: false
        };




        playTogether.onclick= function(){
          /*for(i=0;i<blobArray.length;i++){
              url2=URL.createObjectURL(blobArray[i]);
              audioTogether.src=url2;
              audioTogether.play();
          }*/
          ConcatenateBlobs(blobArray,'audio/wav', function(resultingBlob) {
          
        
            //mediaElement.src = URL.createObjectURL(resultingBlob);
            //mediaElement.play();
            url= URL.createObjectURL(resultingBlob);
                    audio.src = url;
                    document.getElementById('audio-url-preview').innerHTML += '<a href="' + url + '" target="_blank">Recorded Audio URL</a>';
          });
        }

        var audioStream;
        var recorder;
        var url;

        recordAudio.onclick = function() {
            if (!audioStream)
                navigator.getUserMedia(audioConstraints, function(stream) {
                    if (window.IsChrome) stream = new window.MediaStream(stream.getAudioTracks());
                    audioStream = stream;
                    countdown();

                    // "audio" is a default type
                    recorder = window.RecordRTC(stream, {
                        type: 'audio',
                        bufferSize: typeof params.bufferSize == 'undefined' ? 16384 : params.bufferSize,
                        sampleRate: typeof params.sampleRate == 'undefined' ? 44100 : params.sampleRate,
                        leftChannel: params.leftChannel || false,
                        disableLogs: params.disableLogs || false
                    });
                    recorder.startRecording();
                }, function() {});
            else {
                audio.src = URL.createObjectURL(audioStream);
                audio.muted = true;
                audio.play();
                if (recorder) recorder.startRecording();
            }

            window.isAudio = true;

            this.disabled = true;
            stopRecordingAudio.disabled = false;
            pauseResumeAudio.disabled = false;
        };

        stopRecordingAudio.onclick = function() {
            this.disabled = true;
            recordAudio.disabled = false;
            audio.src = '';
            cdpause();
            if (recorder)
                recorder.stopRecording(function(blob) {
                    
                    audio.muted = false;
                    //audio.play();
                    //var blob= recorder.getBlob();
                    /*
                    recorder.getBlob(function(blobs) {
                        var audioBlob= blobs;
                        
                    });
                    document.getElementById('audio-blob-preview').innerHTML = '<a href="' + audioBlob + '" target="_blank">Recorded Audio BLOB</a>';
                    */
                    //var url= URL.createObjectURL(blob);
                    console.log(blob);
                    blobArray.push(blob);
                  
                    url= URL.createObjectURL(blob);
                    audio.src = url;
                    document.getElementById('audio-url-preview').innerHTML += '<a href="' + url + '" target="_blank">Recorded Audio URL</a>';

                    if(flag==1){
                      flag=0;
                      recordAudio.onclick();
                    }
                    //blob=null;


                });
        };
        var state;
        pauseResumeAudio.onclick =  function() {
            console.log("asda");
            if(!recorder) return;
            //audio.src= URL.createObjectURL(audioStream);
            if(this.innerHTML === 'Pause') {
                this.innerHTML = 'Resume';
                recorder.pauseRecording();
                cdpause();
                return;
            }
            
            this.innerHTML = 'Pause';
            countdown();
            recorder.resumeRecording();
        };

    
    $(document).keydown(function(evt)
    {

    if (evt.keyCode == 32) {
        pauseResumeAudio.onclick();
         
    }

    });




    ////TIMER
    function cddisplay() {
        // displays time in span
        document.getElementById("timespan").innerHTML = CCOUNT-count;
    };
    
    function countdown() {
        // starts countdown
        cddisplay();
        console.log("count:"+(CCOUNT-count));
        if(timesecond_arr[realIterator]<=(CCOUNT-count))
        {
          // console.log("time :"+timesecond_arr[realIterator]);
          
          //   console.log("He");

          //   stopRecordingAudio.onclick();

          //   recordAudio.onclick();

            flag=1;
            stopRecordingAudio.onclick();

          
            console.log("Sentence:"+sentence_arr[sentence_arrIterator]);
            $("#previous").html(sentence_arr[sentence_arrIterator-1]);
            $("#current").html("<b>"+sentence_arr[sentence_arrIterator]+"</b>");
            $("#future").html(sentence_arr[sentence_arrIterator+1]);
            realIterator++;
            timesecond_arrIterator++;
            sentence_arrIterator++;
        }
        if (count == 0) {
            // time is up
        } else {
            count--;
            t = setTimeout("countdown()", 1000);
        }
    };
    
    function cdpause() {
        // pauses countdown
        clearTimeout(t);
    };
    
    function cdreset() {
        // resets countdown
        cdpause();
        if(finaltime!=null)
        {CCOUNT=finaltime;
        count = finaltime;
        //Initialize the variables
        realIterator=0;
        sentence_arrIterator=0;
        sequence_arrIterator=0;
        timesecond_arrIterator=0;


        }
        cddisplay();
    };

      </script>
   </div>
</body>
</html>